import{u as Z}from"./bindings-ef4849e6.js";import{r as _,F as ee,E as s,d as o,G as te,o as m,e as le,f as d,g as t,w as l,J as z,p as v,m as A,i,t as S,v as ae,P as ne,K as M}from"./index-3d7d46f8.js";import{_ as oe}from"./_plugin-vue_export-helper-c27b6911.js";const se={class:"bindings-view"},ie={class:"page-header"},re={class:"card-header"},de={class:"card-header"},ue={class:"binding-info"},ce={__name:"BindingsView",setup(_e){const p=Z(),r=_(!0),V=_(!1),f=_(null),y=_(!1),b=_({targetEmail:""}),N={targetEmail:[{required:!0,message:"请输入目标邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}]},h=_(null),C=_([]),w=_([]);ee(async()=>{try{await B()}catch(a){console.error("加载绑定数据失败:",a),s.error("加载绑定数据失败，请稍后重试")}finally{r.value=!1}});const B=async()=>{const a=await p.fetchBindings();C.value=a.bindings,w.value=a.pendingRequests},x=async()=>{r.value=!0;try{await B(),s.success("数据已刷新")}catch(a){console.error("刷新绑定数据失败:",a),s.error("刷新绑定数据失败，请稍后重试")}finally{r.value=!1}},E=a=>new Date(a).toLocaleString(),P=()=>{b.value={targetEmail:""},y.value=!0},T=async()=>{var a,e;if(h.value)try{await h.value.validate(),V.value=!0,await p.bindAccount(b.value.targetEmail),y.value=!1,s.success("绑定请求已发送")}catch(g){console.error("发送绑定请求失败:",g),s.error(((e=(a=g.response)==null?void 0:a.data)==null?void 0:e.message)||"发送绑定请求失败，请稍后重试")}finally{V.value=!1}},j=async a=>{try{await p.updateBindingPermissions(a.id,a.permissions),s.success("权限已更新")}catch(e){console.error("更新权限失败:",e),s.error("更新权限失败，请稍后重试"),await x()}},G=a=>{ae.confirm(`确定要解除与 ${a.bound_account_email} 的绑定吗？`,"警告",{confirmButtonText:"解除绑定",cancelButtonText:"取消",type:"warning"}).then(()=>{I(a)}).catch(()=>{})},I=async a=>{r.value=!0;try{await p.unbindAccount(a.id),s.success("已解除绑定"),await B()}catch(e){console.error("解除绑定失败:",e),s.error("解除绑定失败，请稍后重试")}finally{r.value=!1}},J=async a=>{f.value=a.id;try{await p.acceptBindingRequest(a.id),s.success("已接受绑定请求"),await B()}catch(e){console.error("接受绑定请求失败:",e),s.error("接受绑定请求失败，请稍后重试")}finally{f.value=null}},K=async a=>{f.value=a.id;try{await p.rejectBindingRequest(a.id),s.success("已拒绝绑定请求"),await B()}catch(e){console.error("拒绝绑定请求失败:",e),s.error("拒绝绑定请求失败，请稍后重试")}finally{f.value=null}};return(a,e)=>{const g=o("el-icon"),u=o("el-button"),c=o("el-table-column"),L=o("el-tag"),R=o("el-option"),H=o("el-select"),q=o("el-table"),D=o("el-empty"),$=o("el-card"),O=o("el-badge"),Q=o("el-input"),F=o("el-form-item"),W=o("el-alert"),X=o("el-form"),Y=o("el-dialog"),U=te("loading");return m(),le("div",se,[d("div",ie,[e[4]||(e[4]=d("h1",{class:"page-title"},"账号绑定",-1)),t(u,{type:"primary",onClick:P},{default:l(()=>[t(g,null,{default:l(()=>[t(A(ne))]),_:1}),e[3]||(e[3]=i(" 绑定新账号 ",-1))]),_:1})]),z((m(),v($,{class:"binding-card"},{header:l(()=>[d("div",re,[e[6]||(e[6]=d("span",null,"已绑定账号",-1)),t(u,{type:"text",onClick:x,disabled:r.value},{default:l(()=>[t(g,null,{default:l(()=>[t(A(M))]),_:1}),e[5]||(e[5]=i(" 刷新 ",-1))]),_:1},8,["disabled"])])]),default:l(()=>[C.value.length>0?(m(),v(q,{key:0,data:C.value,style:{width:"100%"}},{default:l(()=>[t(c,{prop:"bound_account_email",label:"账号"}),t(c,{label:"绑定状态",width:"120"},{default:l(n=>[t(L,{type:"success"},{default:l(()=>[...e[7]||(e[7]=[i("已绑定",-1)])]),_:1})]),_:1}),t(c,{label:"权限",width:"120"},{default:l(n=>[t(H,{modelValue:n.row.permissions,"onUpdate:modelValue":k=>n.row.permissions=k,size:"small",style:{width:"90px"},onChange:k=>j(n.row)},{default:l(()=>[t(R,{label:"只读",value:"read"}),t(R,{label:"读写",value:"write"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(c,{label:"绑定时间",width:"180"},{default:l(n=>[i(S(E(n.row.created_at)),1)]),_:1}),t(c,{label:"操作",width:"120"},{default:l(n=>[t(u,{size:"small",type:"danger",plain:"",onClick:k=>G(n.row)},{default:l(()=>[...e[8]||(e[8]=[i(" 解除绑定 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):(m(),v(D,{key:1,description:"暂无绑定账号"}))]),_:1})),[[U,r.value]]),z((m(),v($,{class:"binding-card"},{header:l(()=>[d("div",de,[e[10]||(e[10]=d("span",null,"待处理的绑定请求",-1)),t(O,{value:w.value.length,hidden:w.value.length===0,class:"request-badge"},{default:l(()=>[t(u,{type:"text",onClick:x,disabled:r.value},{default:l(()=>[t(g,null,{default:l(()=>[t(A(M))]),_:1}),e[9]||(e[9]=i(" 刷新 ",-1))]),_:1},8,["disabled"])]),_:1},8,["value","hidden"])])]),default:l(()=>[w.value.length>0?(m(),v(q,{key:0,data:w.value,style:{width:"100%"}},{default:l(()=>[t(c,{prop:"requester_email",label:"请求账号"}),t(c,{label:"请求时间",width:"180"},{default:l(n=>[i(S(E(n.row.created_at)),1)]),_:1}),t(c,{label:"操作",width:"250"},{default:l(n=>[t(u,{size:"small",type:"success",plain:"",onClick:k=>J(n.row),loading:f.value===n.row.id},{default:l(()=>[...e[11]||(e[11]=[i(" 接受 ",-1)])]),_:1},8,["onClick","loading"]),t(u,{size:"small",type:"danger",plain:"",onClick:k=>K(n.row),loading:f.value===n.row.id},{default:l(()=>[...e[12]||(e[12]=[i(" 拒绝 ",-1)])]),_:1},8,["onClick","loading"])]),_:1})]),_:1},8,["data"])):(m(),v(D,{key:1,description:"暂无待处理的绑定请求"}))]),_:1})),[[U,r.value]]),t(Y,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=n=>y.value=n),title:"绑定新账号",width:"500px"},{default:l(()=>[t(X,{ref_key:"bindAccountFormRef",ref:h,model:b.value,rules:N,"label-width":"100px"},{default:l(()=>[t(F,{label:"目标邮箱",prop:"targetEmail"},{default:l(()=>[t(Q,{modelValue:b.value.targetEmail,"onUpdate:modelValue":e[0]||(e[0]=n=>b.value.targetEmail=n),placeholder:"请输入要绑定的账号邮箱",type:"email"},null,8,["modelValue"])]),_:1}),d("div",ue,[t(W,{title:"绑定说明",type:"info",closable:!1},{default:l(()=>[...e[13]||(e[13]=[d("p",null,"绑定后，对方可以访问您的密码库。",-1),d("p",null,"对方需要接受您的绑定请求才能完成绑定。",-1)])]),_:1})]),t(F,null,{default:l(()=>[t(u,{type:"primary",onClick:T,loading:V.value},{default:l(()=>[...e[14]||(e[14]=[i(" 发送绑定请求 ",-1)])]),_:1},8,["loading"]),t(u,{onClick:e[1]||(e[1]=n=>y.value=!1)},{default:l(()=>[...e[15]||(e[15]=[i("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ge=oe(ce,[["__scopeId","data-v-1563f681"]]);export{ge as default};
